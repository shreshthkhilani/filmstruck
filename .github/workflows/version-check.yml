name: Version Check

on:
  pull_request:
    branches: [main]

jobs:
  check-version-bump:
    name: Verify Version Bump
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch main branch
        run: git fetch origin main:main

      - name: Extract versions and compare
        run: |
          CSPROJ_PATH="src/FilmStruck.Cli/FilmStruck.Cli.csproj"

          # Extract version from PR branch
          PR_VERSION=$(grep -oP '<Version>\K[^<]+' "$CSPROJ_PATH")
          echo "PR branch version: $PR_VERSION"

          # Extract version from main branch
          MAIN_VERSION=$(git show main:"$CSPROJ_PATH" | grep -oP '<Version>\K[^<]+')
          echo "Main branch version: $MAIN_VERSION"

          # Function to compare semver versions
          # Returns 0 if v1 > v2, 1 otherwise
          version_gt() {
            test "$(printf '%s\n' "$@" | sort -V | head -n 1)" != "$1"
          }

          if [ "$PR_VERSION" = "$MAIN_VERSION" ]; then
            echo ""
            echo "::error::Version was not bumped!"
            echo ""
            echo "Current version on main: $MAIN_VERSION"
            echo "Version in this PR: $PR_VERSION"
            echo ""
            echo "Please update the version in $CSPROJ_PATH before merging."
            echo "Example: <Version>1.4.0</Version>"
            exit 1
          fi

          if version_gt "$PR_VERSION" "$MAIN_VERSION"; then
            echo ""
            echo "Version bump verified: $MAIN_VERSION -> $PR_VERSION"
          else
            echo ""
            echo "::error::Version must be incremented, not decremented!"
            echo ""
            echo "Current version on main: $MAIN_VERSION"
            echo "Version in this PR: $PR_VERSION"
            echo ""
            echo "Please set a version higher than $MAIN_VERSION in $CSPROJ_PATH"
            exit 1
          fi
